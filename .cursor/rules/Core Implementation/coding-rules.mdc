---
description: 
globs: 
alwaysApply: true
---
# Quy Táº¯c Coding

## 1. Frontend Code Patterns

### Components

- Sá»­ dá»¥ng functional components vá»›i hooks.
- Äá»‹nh nghÄ©a interfaces cho props vá»›i TypeScript.
- Chia nhá» giao diá»‡n thÃ nh cÃ¡c component cÃ³ thá»ƒ tÃ¡i sá»­ dá»¥ng.
- Sá»­ dá»¥ng React.memo Ä‘á»ƒ tá»‘i Æ°u hiá»‡u nÄƒng.
- TuÃ¢n thá»§ quáº£n lÃ½ state Ä‘Ãºng cÃ¡ch.

### Hooks

- Táº¡o custom hooks cho logic tÃ¡i sá»­ dá»¥ng.
- TuÃ¢n thá»§ quy táº¯c cá»§a React hooks.
- Äáº·t tÃªn hook theo quy táº¯c (vÃ­ dá»¥: useXxx).
- ThÃªm TypeScript typing há»£p lÃ½.

### Performance

- ğŸš¨ Minimize `use client`, `useEffect`, vÃ  `setState`â€”Æ°u tiÃªn React Server Components.
- ğŸš¨ Wrap client components trong `Suspense` vá»›i fallback.
- âš ï¸ Sá»­ dá»¥ng dynamic imports cho non-critical components.
- âš ï¸ Optimize images (WebP, lazy loading, explicit dimensions).

### Next.js Best Practices

- ğŸš¨ Sá»­ dá»¥ng `nuqs` cho URL search params.
- âš ï¸ Tá»‘i Æ°u Web Vitals (LCP, CLS, FID).
- âš ï¸ Æ¯u tiÃªn server components & SSR; háº¡n cháº¿ client-side state management.
- ğŸ’¡ TuÃ¢n thá»§ guidelines cá»§a Next.js cho data fetching, rendering, vÃ  routing.

## 2. Backend Code Patterns

### Controllers

- Sá»­ dá»¥ng decorators Ä‘á»ƒ Ä‘á»‹nh nghÄ©a route.
- Sá»­ dá»¥ng DTOs cho viá»‡c validate request.
- Tráº£ vá» response theo Ä‘á»‹nh dáº¡ng nháº¥t quÃ¡n.
- á»¦y quyá»n business logic cho services.
- Sá»­ dá»¥ng status codes HTTP thÃ­ch há»£p.
- Xá»­ lÃ½ lá»—i má»™t cÃ¡ch Ä‘áº§y Ä‘á»§.

### Services

- Sá»­ dá»¥ng dependency injection.
- Thá»±c hiá»‡n business logic.
- Sá»­ dá»¥ng repositories cho truy cáº­p dá»¯ liá»‡u.
- Xá»­ lÃ½ lá»—i há»£p lÃ½.
- Sá»­ dá»¥ng async/await má»™t cÃ¡ch nháº¥t quÃ¡n.
- Tráº£ vá» káº¿t quáº£ Ä‘Ã£ Ä‘Æ°á»£c typed.

### Repositories

- TuÃ¢n thá»§ repository pattern.
- Sá»­ dá»¥ng interfaces Ä‘á»ƒ Ä‘á»‹nh nghÄ©a há»£p Ä‘á»“ng.
- Thá»±c hiá»‡n logic truy cáº­p dá»¯ liá»‡u.
- DÃ¹ng MongoDB vá»›i Mongoose cho dá»¯ liá»‡u phi quan há»‡.
- DÃ¹ng PostgreSQL vá»›i Prisma cho dá»¯ liá»‡u quan há»‡.
- Xá»­ lÃ½ lá»—i vÃ  sá»­ dá»¥ng strong typing.

## 3. NestJS Specific

### Basic Principles

- Sá»­ dá»¥ng kiáº¿n trÃºc module hÃ³a.
- TÃ¡ch riÃªng API theo domain/route:
  - Má»—i module chÃ­nh cho 1 domain/route.
  - Má»™t controller chÃ­nh cho route Ä‘Ã³, kÃ¨m theo cÃ¡c controller phá»¥ náº¿u cáº§n.
  - ThÆ° má»¥c models chá»©a cÃ¡c kiá»ƒu dá»¯ liá»‡u.
  - DTOs Ä‘Æ°á»£c validate vá»›i class-validator.
  - Äá»‹nh nghÄ©a cÃ¡c types Ä‘Æ¡n giáº£n cho outputs.
  - Module services chá»©a business logic vÃ  persistence.
  - Entities sá»­ dá»¥ng MikroORM cho viá»‡c lÆ°u trá»¯ dá»¯ liá»‡u, má»—i entity cÃ³ 1 service riÃªng.
- Module core cho cÃ¡c artifacts cá»§a NestJS:
  - Global filters cho exception handling.
  - Global middlewares cho request management.
  - Guards cho viá»‡c quáº£n lÃ½ permission.
  - Interceptors cho viá»‡c quáº£n lÃ½ request.
- Module shared cho cÃ¡c dá»‹ch vá»¥ dÃ¹ng chung:
  - Utilities vÃ  logic kinh doanh dÃ¹ng chung.

## 4. Database Rules

### MongoDB

- Sá»­ dá»¥ng schemas vá»›i validate.
- Äá»‹nh nghÄ©a cÃ¡c chá»‰ má»¥c (indexes) phÃ¹ há»£p.
- Sá»­ dá»¥ng cÃ¡c kiá»ƒu dá»¯ liá»‡u thÃ­ch há»£p.
- Xá»­ lÃ½ chuyá»ƒn Ä‘á»•i ObjectId má»™t cÃ¡ch Ä‘Ãºng Ä‘áº¯n.
- DÃ¹ng aggregation cho cÃ¡c query phá»©c táº¡p.

### PostgreSQL

- Äá»‹nh nghÄ©a cÃ¡c má»‘i quan há»‡ (relationships) rÃµ rÃ ng.
- Sá»­ dá»¥ng migrations cho cÃ¡c thay Ä‘á»•i schema.
- Äá»‹nh nghÄ©a indexes phÃ¹ há»£p.
- Sá»­ dá»¥ng transactions cho cÃ¡c thao tÃ¡c phá»©c táº¡p.
- Chá»n kiá»ƒu dá»¯ liá»‡u phÃ¹ há»£p.

## 5. Monorepo Guidelines

### Workspace Structure

- Gom cÃ¡c á»©ng dá»¥ng vÃ o thÆ° má»¥c `apps/`
- Gom cÃ¡c thÆ° viá»‡n vÃ  packages dÃ¹ng chung vÃ o `packages/`
- Sá»­ dá»¥ng Turborepo cho viá»‡c quáº£n lÃ½ lá»‡nh vÃ  dependencies

### Package References

- Sá»­ dá»¥ng Ä‘Æ°á»ng dáº«n tÆ°Æ¡ng Ä‘á»‘i khi tham chiáº¿u giá»¯a cÃ¡c package trong monorepo
- Trong tsconfig.json, nÃªn sá»­ dá»¥ng Ä‘Æ°á»ng dáº«n tÆ°Æ¡ng Ä‘á»‘i vá»›i tá»‡p extends
- Äáº£m báº£o Ä‘Æ°á»ng dáº«n trong cÃ¡c import pháº£i chÃ­nh xÃ¡c

### Development Workflow

- Cháº¡y `npm run dev` á»Ÿ thÆ° má»¥c gá»‘c Ä‘á»ƒ phÃ¡t triá»ƒn toÃ n bá»™ workspace
- Sá»­ dá»¥ng `npm run dev --filter={package-name}` Ä‘á»ƒ chá»‰ cháº¡y má»™t package cá»¥ thá»ƒ
- Äáº£m báº£o cÃ¡c package cÃ³ phiÃªn báº£n tÆ°Æ¡ng thÃ­ch vá»›i nhau

## 6. Xá»­ LÃ½ Lá»—i Chuáº©n

### Error Handling Frontend

- Sá»­ dá»¥ng try-catch cho async operations
- Sá»­ dá»¥ng Error Boundaries cho client components
- Tráº£ vá» user-friendly error messages
- Sá»­ dá»¥ng toast notifications khi cáº§n

### Error Handling Backend

- Sá»­ dá»¥ng global exception filters trong NestJS
- Tráº£ vá» HTTP status codes phÃ¹ há»£p
- Cung cáº¥p error codes vÃ  messages rÃµ rÃ ng
- Log errors Ä‘áº§y Ä‘á»§ (khÃ´ng log sensitive information)

## 7. Báº£o Máº­t

### Frontend Security Checklist

- [ ] XÃ¡c thá»±c táº¥t cáº£ input tá»« ngÆ°á»i dÃ¹ng
- [ ] TrÃ¡nh XSS báº±ng cÃ¡ch sá»­ dá»¥ng React (khÃ´ng dÃ¹ng dangerouslySetInnerHTML)
- [ ] KhÃ´ng lÆ°u thÃ´ng tin nháº¡y cáº£m trong localStorage/sessionStorage
- [ ] Sá»­ dá»¥ng HTTPS cho táº¥t cáº£ API calls
- [ ] Triá»ƒn khai CSP (Content Security Policy)
- [ ] Báº£o vá»‡ chá»‘ng CSRF
- [ ] Sá»­ dá»¥ng httpOnly cookies cho authentication
- [ ] Implement rate limiting cho forms

### Backend Security Checklist

- [ ] Validate táº¥t cáº£ input tá»« client
- [ ] Sá»­ dá»¥ng prepared statements cho database queries
- [ ] Implement rate limiting
- [ ] Set security headers
- [ ] Cáº¥u hÃ¬nh CORS Ä‘Ãºng cÃ¡ch
- [ ] KhÃ´ng tráº£ vá» thÃ´ng tin nháº¡y cáº£m trong error messages
- [ ] Implement phÃ¢n quyá»n Ä‘Ãºng Ä‘áº¯n
- [ ] Sá»­ dá»¥ng cÃ¡c thÆ° viá»‡n Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t

## 8. Testing Guidelines

- Viáº¿t unit tests cho services vÃ  repositories.
- Sá»­ dá»¥ng Jest lÃ m framework test.
- Mock cÃ¡c dependency bÃªn ngoÃ i.
- Test cáº£ trÆ°á»ng há»£p thÃ nh cÃ´ng vÃ  lá»—i.
- Sá»­ dá»¥ng mÃ´ hÃ¬nh AAA (Arrange, Act, Assert) trong mÃ´ táº£ test.
